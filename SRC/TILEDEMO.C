#include <stdio.h>
#include <dos.h>
#include <conio.h>
#include "lores.h"
#include "tiler.h"
#include "sprite.h"
extern volatile unsigned int frameCount;
/*
 * Map and tile data
 */
unsigned char testile[] = {0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22};
unsigned char grass[] = {  0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x2A, 0x22, 0x22, 0x22, 0x22, 0x32, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x32, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0xA2, 0x22, 0x22, 0xA2,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x32, 0x22, 0x22, 0x22, 0x2A, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x2A, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x2A, 0x22, 0x22, 0x23, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22};
unsigned char tree[] = {   0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0xA2, 0xAA, 0x2A, 0x2A, 0x22, 0x22,
                           0x22, 0xA2, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0x22,
                           0x22, 0xA2, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0x22,
                           0x22, 0x22, 0x2A, 0xA2, 0x2A, 0xA2, 0x2A, 0x22,
                           0x22, 0xAA, 0x2A, 0xAA, 0xAA, 0xA2, 0xAA, 0x22,
                           0x22, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0xAA, 0x22,
                           0x22, 0xA2, 0xAA, 0xAA, 0xA2, 0x2A, 0xAA, 0x22,
                           0x22, 0xAA, 0xAA, 0xAA, 0xA2, 0x2A, 0x2A, 0x22,
                           0x22, 0xA2, 0x2A, 0x22, 0xAA, 0xA2, 0xAA, 0x22,
                           0x22, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0xAA, 0x22,
                           0x22, 0x22, 0xAA, 0xAA, 0xAA, 0x22, 0xAA, 0x22,
                           0x22, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0x22,
                           0x22, 0xA2, 0xA2, 0xAA, 0xAA, 0xAA, 0x2A, 0x22,
                           0x22, 0x22, 0xA2, 0xAA, 0x22, 0xAA, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22};
unsigned char dirt[] = {   0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x76,
                           0x66, 0x60, 0x66, 0x66, 0x66, 0x60, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x67, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x06, 0x66, 0x76, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x06, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x06, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x76, 0x66, 0x66};
unsigned char water[] = {  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x99, 0x11, 0x99, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x99, 0x11, 0x99, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x99, 0x11, 0x99,
                           0x99, 0x11, 0x11, 0x11, 0x11, 0x11, 0x99, 0x11,
                           0x11, 0x11, 0x77, 0x11, 0x77, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x77, 0x11, 0x77, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x99, 0x11, 0x99, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x99, 0x11, 0x99, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11};
unsigned char far *tilemap[16][16];
/*
 * Build map from text representation
 *  . = grass
 *  * = tree
 *  # = dirt
 *  ~ = water
 */
unsigned char *map[] = {"................",
                        "..***...###.....",
                        ".****..##.###...",
                        "***~**.#....###.",
                        "**~~~*.#...~~~#~",
                        "~~~?~~~#~~~~..#.",
                        "*~~~**.#....###.",
                        ".****..#..###...",
                        ".****..####.....",
                        "..**..##........",
                        ".*...##..****...",
                        ".#####..*....*..",
                        "##.*...*.#..#.*.",
                        "#......*......*.",
                        "##.*....*.##.*..",
                        ".###.....****..."};
void buildmap(void)
{
    int row, col;
    unsigned char far *tileptr;

    for (row = 0; row < 16; row++)
    {
        for (col = 0; col < 16; col++)
        {
            switch (map[row][col])
            {
                case '.':
                    tileptr = grass;
                    break;
                case '*':
                    tileptr = tree;
                    break;
                case '#':
                    tileptr = dirt;
                    break;
                case '~':
                    tileptr = water;
                    break;
                default:
                    tileptr = testile;
            }
            tilemap[row][col] = tileptr;
        }
    }
}
/*
 * 20X20 Sprite
 */
#define FACE_WIDTH      20
#define FACE_HEIGHT     20
#define FACEBUF_WIDTH   (FACE_WIDTH+4)
#define FACEBUF_HEIGHT  (FACE_HEIGHT+4)

unsigned char face[FACE_HEIGHT*FACE_WIDTH/2] = {
     0x88, 0x88, 0x88, 0xE8, 0xEE, 0xEE, 0x8E, 0x88, 0x88, 0x88,
     0x88, 0x88, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x88, 0x88,
     0x88, 0xE8, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x8E, 0x88,
     0x88, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x88,
     0x88, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x88,
     0xE8, 0xEE, 0xEE, 0xE1, 0xEE, 0xEE, 0x1E, 0xEE, 0xEE, 0x8E,
     0xE8, 0xEE, 0x1E, 0x11, 0xEE, 0xEE, 0x11, 0xE1, 0xEE, 0x8E,
     0xEE, 0xEE, 0xEE, 0xE1, 0xEE, 0xEE, 0x1E, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xE8, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x8E,
     0xE8, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x8E,
     0x88, 0xEE, 0x44, 0xEE, 0xEE, 0xEE, 0xEE, 0x44, 0xEE, 0x88,
     0x88, 0xEE, 0xEE, 0x44, 0x44, 0x44, 0x44, 0xEE, 0xEE, 0x88,
     0x88, 0xE8, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x8E, 0x88,
     0x88, 0x88, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x88, 0x88,
     0x88, 0x88, 0x88, 0xE8, 0xEE, 0xEE, 0x8E, 0x88, 0x88, 0x88};
/*
 * Demo tiling and scrolling screen
 */
int main(int argc, char **argv)
{
    unsigned int s, t;
    unsigned long st;
    int scrolldir;
    unsigned char *facebuf;
    unsigned char *scrnbuf;

    buildmap();
    gr160(0);
    facebuf = (unsigned char *)malloc(FACEBUF_HEIGHT*FACEBUF_WIDTH/2);
    /*
     * Set initial coordinates and scroll direction.
     * Horizontal scroll increment must be two,
     * vertical scroll increment can be two or one.
     */
    s = 2 << 4;
    t = 4 << 4;
    scrolldir = SCROLL_RIGHT2 | SCROLL_UP2;
#ifdef SW_SCROLL
    /*
     * Use software scrolling
     */
    tileInit(0, 0, 16, 16, (unsigned char far * far *)tilemap);
#if 0
    while (!kbhit())
    {
        /*
         * Change scroll direction at map boundaries
         */
        if (s == ((16 << 4) - 162) || s == 0) scrolldir ^= SCROLL_LEFT2 | SCROLL_RIGHT2;
        if (t == ((16 << 4) - 102) || t == 0) scrolldir ^= SCROLL_UP2   | SCROLL_DOWN2;
        /*
         * Move origin based on scroll direction
         */
        if (scrolldir & SCROLL_LEFT2)
            s += 2;
        else if (scrolldir & SCROLL_RIGHT2)
            s -= 2;
        if (scrolldir & SCROLL_UP2)
            t += 2;
        else if (scrolldir & SCROLL_DOWN2)
            t -= 2;
        /*
         * Place sprite in middle of screen
         */
        tileBuf(s + 80-FACEBUF_WIDTH/2, t + 50-FACEBUF_HEIGHT/2, FACEBUF_WIDTH, FACEBUF_HEIGHT, facebuf);
        spriteBuf(2, 2, FACE_WIDTH, FACE_HEIGHT, face, FACEBUF_WIDTH/2, facebuf);
        tileScrn(s, t);
        cpyBuf(80-FACEBUF_WIDTH/2, 50-FACEBUF_HEIGHT/2, FACEBUF_WIDTH, FACEBUF_HEIGHT, facebuf);
        //if (getch() == 'Q') {txt80(); tileExit(); return 0;}
    }
    getch();
#endif
#if 1
    scrnbuf = (unsigned char *)malloc(160/2*100);
    while (!kbhit())
    {
        /*
         * Change scroll direction at map boundaries
         */
        if (s == ((16 << 4) - 162) || s == 0) scrolldir ^= SCROLL_LEFT2 | SCROLL_RIGHT2;
        if (t == ((16 << 4) - 102) || t == 0) scrolldir ^= SCROLL_UP2   | SCROLL_DOWN2;
        /*
         * Move origin based on scroll direction
         */
        if (scrolldir & SCROLL_LEFT2)
            s += 2;
        else if (scrolldir & SCROLL_RIGHT2)
            s -= 2;
        if (scrolldir & SCROLL_UP2)
            t += 2;
        else if (scrolldir & SCROLL_DOWN2)
            t -= 2;
        /*
         * Place sprite in middle of screen
         */
        tileBuf(s, t, 160, 100, scrnbuf);
        spriteBuf(80-FACEBUF_WIDTH/2, 50-FACEBUF_HEIGHT/2, FACE_WIDTH, FACE_HEIGHT, face, 80, scrnbuf);
        cpyBuf(0, 0, 160, 100, scrnbuf);
        //if (getch() == 'Q') {txt80(); tileExit(); return 0;}
    }
    getch();
    free(scrnbuf);
#endif
#else // SW_SCROLL
    /*
     * Use hardware scrolling
     */
    tileInit(s, t, 16, 16, (unsigned char far * far *)tilemap);
#if 1
    while (!kbhit())
    {
        /*
         * Change scroll direction at map boundaries
         */
        if (s == ((16 << 4) - 162) || s == 0) scrolldir ^= SCROLL_LEFT2 | SCROLL_RIGHT2;
        if (t == ((16 << 4) - 102) || t == 0) scrolldir ^= SCROLL_UP2   | SCROLL_DOWN2;
        /*
         * Move origin based on scroll direction
         */
        if (scrolldir & SCROLL_LEFT2)
            s += 2;
        else if (scrolldir & SCROLL_RIGHT2)
            s -= 2;
        if (scrolldir & SCROLL_UP2)
            t += 2;
        else if (scrolldir & SCROLL_DOWN2)
            t -= 2;
        /*
         * Place sprite in middle of screen
         */
        outp(0x3D9, 0x0F);
        tileBuf(s + 80-FACEBUF_WIDTH/2, t + 50-FACEBUF_HEIGHT/2, FACEBUF_WIDTH, FACEBUF_HEIGHT, facebuf);
        //tileBuf(s, t, FACEBUF_WIDTH, FACEBUF_HEIGHT, facebuf);
        spriteBuf(2, 2, FACE_WIDTH, FACE_HEIGHT, face, FACEBUF_WIDTH/2, facebuf);
        outp(0x3D9, 0x06);
        st = tileScroll(scrolldir);
        outp(0x3D9, 0x00);
        s  = st;
        t  = st >> 16;
        cpyBuf(s + 80-FACEBUF_WIDTH/2, t + 50-FACEBUF_HEIGHT/2, FACEBUF_WIDTH, FACEBUF_HEIGHT, facebuf);
        //cpyBuf(s, t, FACEBUF_WIDTH, FACEBUF_HEIGHT, facebuf);
        outp(0x3D9, 0x06);
        //if (getch() == 'Q') {txt80(); tileExit(); return 0;}
    }
    getch();
#endif
#if 0
    /*
     * Switch to scrolling vertically by one
     */
    if (scrolldir & SCROLL_UP2)
        scrolldir ^= SCROLL_UP2 | SCROLL_UP;
    else if (scrolldir & SCROLL_DOWN2)
        scrolldir ^= SCROLL_DOWN2 | SCROLL_DOWN;
    while (!kbhit())
    {
        frameCount = 0;
        while (frameCount < 60)
        {
            /*
             * Change scroll direction at map boundaries
             */
            if (s == ((16 << 4) - 162) || s == 0) scrolldir ^= SCROLL_LEFT2 | SCROLL_RIGHT2;
            if (t == ((16 << 4) - 101) || t == 0) scrolldir ^= SCROLL_UP    | SCROLL_DOWN;
            /*
             * Move origin based on scroll direction
             */
            if (scrolldir & SCROLL_LEFT2)
                s += 2;
            else if (scrolldir & SCROLL_RIGHT2)
                s -= 2;
            if (scrolldir & SCROLL_UP)
                t++;
            else if (scrolldir & SCROLL_DOWN)
                t--;
            /*
             * Place sprite in middle of screen
             */
            outp(0x3D9, 0x0F);
            tileBuf(s + 80-FACEBUF_WIDTH/2, t + 50-FACEBUF_HEIGHT/2, FACEBUF_WIDTH, FACEBUF_HEIGHT, facebuf);
            spriteBuf(2, 2, FACE_WIDTH, FACE_HEIGHT, face, FACEBUF_WIDTH/2, facebuf);
            outp(0x3D9, 0x06);
            st = tileScroll(scrolldir);
            outp(0x3D9, 0x00);
            s  = st;
            t  = st >> 16;
            cpyBuf(s + 80-FACEBUF_WIDTH/2, t + 50-FACEBUF_HEIGHT/2, FACEBUF_WIDTH, FACEBUF_HEIGHT, facebuf);
            outp(0x3D9, 0x06);
            //if (getch() == 'Q') {txt80(); tileExit(); return 0;}
        }
    }
    getch();
#endif
#endif // SW_SCROLL
    txt80();
    tileExit();
    return 0;
}
