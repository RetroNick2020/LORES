#include <stdio.h>
#include <dos.h>
#include <conio.h>
#include "lores.h"
#include "tiler.h"

extern volatile unsigned int frameCount;

/*
 * Map and tile data
 */
unsigned char testile[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0x9F, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9,
                           0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
unsigned char testile1[] = {0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0x9F, 0x99, 0x99, 0x99, 0x99, 0xF9, 0x22,
                           0x22, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22};
unsigned char testile2[] = {0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0xFF, 0xFF, 0xFF, 0xFF, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0x9F, 0x99, 0x99, 0xF9, 0x22, 0x22,
                           0x22, 0x22, 0xFF, 0xFF, 0xFF, 0xFF, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22};
unsigned char testile3[] = {0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0xFF, 0xFF, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x9F, 0xF9, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x9F, 0xF9, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x9F, 0xF9, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x9F, 0xF9, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x9F, 0xF9, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x9F, 0xF9, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x9F, 0xF9, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x9F, 0xF9, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0xFF, 0xFF, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                          0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22};

unsigned char far *tileAnimate[4] = {testile, testile1, testile2, testile3};
unsigned char grass[] = {  0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x2A, 0x22, 0x22, 0x22, 0x22, 0x32, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x32, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0xA2, 0x22, 0x22, 0xA2,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x32, 0x22, 0x22, 0x22, 0x2A, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x2A, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x2A, 0x22, 0x22, 0x23, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22};
unsigned char tree[] = {   0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
                           0x22, 0x22, 0xA2, 0xAA, 0x2A, 0x2A, 0x22, 0x22,
                           0x22, 0xA2, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0x22,
                           0x22, 0xA2, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0x22,
                           0x22, 0x22, 0x2A, 0xA2, 0x2A, 0xA2, 0x2A, 0x22,
                           0x22, 0xAA, 0x2A, 0xAA, 0xAA, 0xA2, 0xAA, 0x22,
                           0x22, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0xAA, 0x22,
                           0x22, 0xA2, 0xAA, 0xAA, 0xA2, 0x2A, 0xAA, 0x22,
                           0x22, 0xAA, 0xAA, 0xAA, 0xA2, 0x2A, 0x2A, 0x22,
                           0x22, 0xA2, 0x2A, 0x22, 0xAA, 0xA2, 0xAA, 0x22,
                           0x22, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0xAA, 0x22,
                           0x22, 0x22, 0xAA, 0xAA, 0xAA, 0x22, 0xAA, 0x22,
                           0x22, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x2A, 0x22,
                           0x22, 0xA2, 0xA2, 0xAA, 0xAA, 0xAA, 0x2A, 0x22,
                           0x22, 0x22, 0xA2, 0xAA, 0x22, 0xAA, 0x22, 0x22,
                           0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22};
unsigned char dirt[] = {   0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x76,
                           0x66, 0x60, 0x66, 0x66, 0x66, 0x60, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x67, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x06, 0x66, 0x76, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x06, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x06, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66,
                           0x66, 0x66, 0x66, 0x66, 0x66, 0x76, 0x66, 0x66};
unsigned char water[] = {  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x99, 0x11, 0x99, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x99, 0x11, 0x99, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x99, 0x11, 0x99,
                           0x99, 0x11, 0x11, 0x11, 0x11, 0x11, 0x99, 0x11,
                           0x11, 0x11, 0x77, 0x11, 0x77, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x77, 0x11, 0x77, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x99, 0x11, 0x99, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x99, 0x11, 0x99, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
                           0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11};
unsigned char far *tilemap[16][16];
/*
 * Build map from text representation
 *  . = grass
 *  * = tree
 *  # = dirt
 *  ~ = water
 */
unsigned char *map[] = {"................",
                        "..***...###.....",
                        ".****..##.###...",
                        "***~**.#....###.",
                        "**~~~*.#...~~~#~",
                        "~~~~~~~#~~~~..#.",
                        "*~~~**.#....###.",
                        ".****..#..###...",
                        ".****..#?##.....",
                        "..**..##........",
                        ".*...##..****...",
                        ".#####..*....*..",
                        "##.*...*.#..#.*.",
                        "#......*......*.",
                        "##.*....*.##.*..",
                        ".###.....****..."};
void buildmap(void)
{
    int row, col;
    unsigned char far *tileptr;

    for (row = 0; row < 16; row++)
    {
        for (col = 0; col < 16; col++)
        {
            switch (map[row][col])
            {
                case '.':
                    tileptr = grass;
                    break;
                case '*':
                    tileptr = tree;
                    break;
                case '#':
                    tileptr = dirt;
                    break;
                case '~':
                    tileptr = water;
                    break;
                default:
                    tileptr = testile;
            }
            tilemap[row][col] = tileptr;
        }
    }
}
/*
 * 20X20 Sprite
 */
#define FACE_WIDTH      20
#define FACE_HEIGHT     20
#define FACEBUF_WIDTH   (FACE_WIDTH+4)
#define FACEBUF_HEIGHT  (FACE_HEIGHT+4)

unsigned char face[FACE_HEIGHT*FACE_WIDTH/2] = {
     0x88, 0x88, 0x88, 0xE8, 0xEE, 0xEE, 0x8E, 0x88, 0x88, 0x88,
     0x88, 0x88, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x88, 0x88,
     0x88, 0xE8, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x8E, 0x88,
     0x88, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x88,
     0x88, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x88,
     0xE8, 0xEE, 0xEE, 0xE1, 0xEE, 0xEE, 0x1E, 0xEE, 0xEE, 0x8E,
     0xE8, 0xEE, 0x1E, 0x11, 0xEE, 0xEE, 0x11, 0xE1, 0xEE, 0x8E,
     0xEE, 0xEE, 0xEE, 0xE1, 0xEE, 0xEE, 0x1E, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE,
     0xE8, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x8E,
     0xE8, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x8E,
     0x88, 0xEE, 0x44, 0xEE, 0xEE, 0xEE, 0xEE, 0x44, 0xEE, 0x88,
     0x88, 0xEE, 0xEE, 0x44, 0x44, 0x44, 0x44, 0xEE, 0xEE, 0x88,
     0x88, 0xE8, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x8E, 0x88,
     0x88, 0x88, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0x88, 0x88,
     0x88, 0x88, 0x88, 0xE8, 0xEE, 0xEE, 0x8E, 0x88, 0x88, 0x88};
unsigned char angry[FACE_HEIGHT*FACE_WIDTH/2] = {
     0x88, 0x88, 0x88, 0xC8, 0xCC, 0xCC, 0x8C, 0x88, 0x88, 0x88,
     0x88, 0x88, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x88, 0x88,
     0x88, 0xC8, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x8C, 0x88,
     0x88, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x88,
     0x88, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x88,
     0xC8, 0xCC, 0xC1, 0xCC, 0xCC, 0xCC, 0xCC, 0x1C, 0xCC, 0x8C,
     0xC8, 0xCC, 0x1C, 0x11, 0xCC, 0xCC, 0x11, 0xC1, 0xCC, 0x8C,
     0xCC, 0xCC, 0xCC, 0xC1, 0xCC, 0xCC, 0x1C, 0xCC, 0xCC, 0xCC,
     0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC,
     0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC,
     0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC,
     0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC,
     0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC,
     0xC8, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x8C,
     0xC8, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x8C,
     0x88, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x88,
     0x88, 0xCC, 0xCC, 0xCC, 0x44, 0x44, 0xCC, 0xCC, 0xCC, 0x88,
     0x88, 0xC8, 0xCC, 0x44, 0xCC, 0xCC, 0x44, 0xCC, 0x8C, 0x88,
     0x88, 0x88, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x88, 0x88,
     0x88, 0x88, 0x88, 0xC8, 0xCC, 0xCC, 0x8C, 0x88, 0x88, 0x88};

/*
 * Demo tiling and scrolling screen
 */
int main(int argc, char **argv)
{
    unsigned int faceS, viewS, faceT, viewT;
    int incS, incT;
    unsigned long st;
    int movedir, scrolldir;
    unsigned char cycle;
    unsigned char *facebuf;
    unsigned char *scrnbuf;

    buildmap();
    facebuf = (unsigned char *)malloc(FACEBUF_HEIGHT*FACEBUF_WIDTH/2);
    /*
     * Set initial coordinates and scroll direction.
     * Horizontal scroll increment must be two,
     * vertical scroll increment can be two or one.
     */
    incS    = 2;
    incT    = 2;
    faceS   = 0x80;
    faceT   = 0xA0;
    viewS   = 0x84 - 80;
    viewT   = 0x84 - 50;
    /*
     * Use hardware scrolling on CGA
     */
    viewInit(gr160(BLACK, BROWN), viewS, viewT, 16, 16, (unsigned char far * far *)tilemap);
    spriteEnable(0, faceS, faceT, FACE_WIDTH, FACE_HEIGHT, face);
    spriteEnable(1, 0x94, 0x74, FACE_WIDTH, FACE_HEIGHT, angry);
    viewRefresh(0);
    cycle = 0;
    while (!kbhit())
    {
        frameCount = 0;
        while (frameCount < 60)
        {
#ifdef PROFILE
            rasterBorder(BLACK);
#endif
            /*
             * Update a tile on-the-fly
             */
            tileUpdate(8, 8, tileAnimate[cycle++ & 0x03]);
            /*
             * Change scroll direction at map boundaries
             */
            if ((faceS >= ((16 << 4) - FACE_WIDTH - 2))  || (faceS < 2)) incS = -incS;
            if ((faceT >= ((16 << 4) - FACE_HEIGHT - 2)) || (faceT < 2)) incT = -incT;
            st = spritePosition(0, faceS + incS, faceT + incT);
            faceS = st;
            faceT = st >> 16;
            /*
             * Attempt to keep sprite centered by scrolling map
             */
            scrolldir = 0;
            if (faceS < viewS + (80 - FACE_WIDTH/2))
                scrolldir = SCROLL_RIGHT2;
            else if (faceS > viewS + (80 - FACE_WIDTH/2))
                scrolldir = SCROLL_LEFT2;
            if (faceT < viewT + (50 - FACE_HEIGHT/2))
                scrolldir |= SCROLL_DOWN2;
            else if (faceT > viewT + (50 - FACE_HEIGHT/2))
                scrolldir |= SCROLL_UP2;
#ifdef PROFILE
            rasterBorder(BROWN);
#endif
            st = viewRefresh(scrolldir);
            viewS  = st;
            viewT  = st >> 16;
#ifdef PROFILE
            rasterBorder(BROWN);
#endif
            //if (getch() == 'Q') {txt80(); viewExit(); return 0;}
        }
    }
    getch();
    viewExit();
    txt80();
    return 0;
}
